# 2024-01-08
----------------

# ğŸƒ Springboot
## Token ê¸°ë°˜ ì¸ì¦
 - íŠ¹ì§•
    - ë¬´ìƒíƒœì„± : ì¸ì¦ ì •ë³´ê°€ ì„œë²„ì— ìˆëŠ”ê²Œ ì•„ë‹ˆë¼ í´ë¼ì´ì–¸íŠ¸ì— ìˆëŠ” ê²ƒ
    - í™•ì¥ì„± : í´ë¼ì´ì–¸íŠ¸ ìì²´ì— í† í°ì´ ì¡´ì¬í•˜ê¸° ë•Œë¬¸ì— ì„¸ì…˜ ë°©ì‹ë³´ë‹¤ í™•ì¥ì„±ì— ìœ ë¦¬í•˜ë‹¤.
    - ë¬´ê²°ì„± : í† í° ë°œê¸‰ ì´í›„ì— í† í° ì •ë³´ ë³€ê²½ì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤. (í† í° ë°©ì‹ì„ HMAC ê¸°ë²• ì´ë¼ê³  ë¶€ë¦„)
## JWT ?
> Json Web Token 
- JSON í¬ë§·ì„ ì´ìš©í•˜ì—¬ ì‚¬ìš©ìì— ëŒ€í•œ ì†ì„±(ìœ„ì—ì„œì˜ ìœ ì € ì •ë³´)ì„ ì €ì¥í•˜ëŠ” Claim ê¸°ë°˜ì˜ Web Token

ğŸ“‚config / ğŸ“‚jwt /
ğŸ—’ï¸TokenProvider.java
```java
package com.devfeat.springbootdeveloper.config.jwt;


import io.jsonwebtoken.Claims;
import io.jsonwebtoken.Header;
import io.jsonwebtoken.Jwts;

import com.devfeat.springbootdeveloper.domain.User;
import io.jsonwebtoken.SignatureAlgorithm;
import lombok.RequiredArgsConstructor;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.stereotype.Service;

import java.time.Duration;
import java.util.Collections;
import java.util.Date;
import java.util.Set;

@RequiredArgsConstructor
@Service
public class TokenProvider {

    private final JwtProperties jwtProperties;

    // ìœ ì € ì •ë³´ì™€ ë§Œë£Œ ì‹œê°„ì„ ë°›ì•„ì„œ JWT ë¥¼ ìƒì„± í•˜ëŠ” ë©”ì†Œë“œ
    public String generateToken(User user, Duration expiredAt) { 
        Date now = new Date(); // í˜„ì¬ ì‹œê°„ì„ ë‚˜íƒ€ë‚´ëŠ” Date ê°ì²´ ìƒì„±
        return makeToken(new Date(now.getTime() + expiredAt.toMillis()),user); // í˜„ì¬ ì‹œê°„ + ë§Œë£Œì‹œê°„ì„ ë”í•œ ìƒˆë¡œìš´ Date ê°ì²´ ìƒì„±
    }

    // JWTë¥¼ ì‹¤ì œë¡œ ìƒì„±í•˜ëŠ” ë©”ì†Œë“œ
    private String makeToken(Date expiry, User user) {  
        Date now = new Date();

        return Jwts.builder()   // JWT ìƒì„± 
                .setHeaderParam(Header.TYPE, Header.JWT_TYPE) // JWT í—¤ë” íŒŒë¼ë¯¸í„° ì„¤ì •(í† í°íƒ€ì…:JWT ì¸ ê²ƒì„ ëª…ì‹œ)
                .setIssuer(jwtProperties.getIssuer()) // í† í° ë°œí–‰ì ì„¤ì •
                .setIssuedAt(now) // í† í°ì˜ ë°œí–‰ ì‹œê°„ ì„¤ì •
                .setExpiration(expiry) // í† í°ì˜ ë§Œë£Œ ì‹œê°„ ì„¤ì •
                .setSubject(user.getEmail()) // í† í°ì˜ ì£¼ì œë¥¼ ì„¤ì •(ì´ë©”ì¼)
                .claim("id", user.getId()) // JWT body ë¶€ë¶„ì¸ claim ì„ ì•„ì´ë””ë¡œ ì„¤ì •
                .signWith(SignatureAlgorithm.HS256, jwtProperties.getSecretKey()) // HS256 ì•Œê³ ë¦¬ì¦˜ê³¼ ë¹„ë°€ í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ í† í°ì— ì¸ì¦(ì„œëª…)
                .compact(); // í† í°ì„ ì••ì¶•í•˜ì—¬ ë¬¸ìì—´ë¡œ ë§Œë“¦
    }

    // í† í°ì´ ìœ íš¨í•œì§€ ê²€ì¦í•˜ëŠ” ë©”ì†Œë“œ
    public boolean validToken(String token) {
        try {
            Jwts.parser()
                    .setSigningKey(jwtProperties.getSecretKey()) // ì‹œí¬ë¦¿ í‚¤ í™•ì¸
                    .parseClaimsJws(token); // ì„œëª…ëœ JWT íŒŒì‹±ì— ëŒ€í•œ ì •í™•í•œ ë³´ì•ˆ ëª¨ë¸ì„ í™•ì¸
            return true;
        } catch (Exception e) {
            return false;
        }
    }

    // í† í°ì„ ê¸°ë°˜ìœ¼ë¡œ í•´ì„œ UsernamePasswordAuthenticationToken ì„ ìƒì„±í•˜ëŠ” ë©”ì†Œë“œ
    public UsernamePasswordAuthenticationToken getAuthentication(String token) {
        Claims claims = getClaims(token); // í† í°ì—ì„œ í´ë ˆì„ì„ ì¶”ì¶œí•©ë‹ˆë‹¤.
        
        // ì‚¬ìš©ìì˜ ê¶Œí•œì„ ì„¤ì • : ROLE_USER ë¼ëŠ” ê¶Œí•œìœ¼ë¡œ ì„¤ì •
        Set<SimpleGrantedAuthority> authorities = Collections.singleton(new SimpleGrantedAuthority("ROLE_USER")); 

        return new UsernamePasswordAuthenticationToken(new org.springframework.security.core.userdetails.User(claims.getSubject
                (), "", authorities), token, authorities);
    }

    // í† í°ì—ì„œ ì‚¬ìš©ì ID ë¥¼ ì¶”ì¶œí•˜ëŠ” ë©”ì†Œë“œ
    public Long getUserId(String token) {
        Claims claims = getClaims(token); // í† í°ì—ì„œ í´ë ˆì„ì„ ì¶”ì¶œ
        return claims.get("id", Long.class); // í´ë ˆì„ì—ì„œ id ë¥¼ ê°€ì ¸ì™€ì„œ ë°˜í™˜
    }

    // í† í°ì—ì„œ í´ë ˆì„ ì§‘í•©ì„ ì¶”ì¶œí•˜ëŠ” ë©”ì†Œë“œ
    private Claims getClaims(String token) {
        return Jwts.parser() // í† í°ì„ íŒŒì‹±í•˜ì—¬ í´ë ˆì„ ë°˜í™˜
                .setSigningKey(jwtProperties.getSecretKey()) //  ì„œëª… í‚¤ ì„¤ì •
                .parseClaimsJws(token) // í† í° íŒŒì‹±
                .getBody(); // ë³¸ë¬¸ ë¦¬í„´
    }
}
```
### JWT ì‘ì„± ì½”ë“œ
```bash
ğŸ“‚com.devfeat.developBlog   
â”— ğŸ“‚config
    â”— ğŸ“‚jwt   
        â”—ğŸ—’ï¸TokenApiController.java
        â”—ğŸ—’ï¸JwtProperties.java
    â”—ğŸ—’ï¸TokenAuthenticationFilter.java
 â”— ğŸ“‚controller
    â”—ğŸ—’ï¸TokenApiController.java
 â”— ğŸ“‚domain
    â”—ğŸ—’ï¸RefreshToken.java
 â”— ğŸ“‚dto
    â”—ğŸ—’ï¸CreateAccessTokenRequest.java
    â”—ğŸ—’ï¸CreateAccessTokenResponse.java
 â”— ğŸ“‚repository
    â”—ğŸ—’ï¸RefreshTokenRepository.java
 â”— ğŸ“‚service
    â”—ğŸ—’ï¸RefreshTokenService.java
    â”—ğŸ—’ï¸TokenService.java
```



### JWT ì „ì²´ íë¦„
1. ì‚¬ìš©ìê°€ ì¸ì¦ì„ ìœ„í•´ íšŒì›ê°€ì… í›„ ë¡œê·¸ì¸ ì™„ë£Œ í›„ /api/token ìœ¼ë¡œ ì´ë™ 
2. ğŸ“‚controller / ğŸ—’ï¸TokenApiController.java ì—ì„œ /api/token postmapping
3. tokenservice ì—ì„œ createNewAccessToken ë©”ì†Œë“œ ì‹¤í–‰
 - token provider ì—ì„œ validToken ë©”ì†Œë“œë¥¼ í†µí•´ í† í° ìœ íš¨í•œì§€ ê²€ì‚¬(jwtPropertiesì˜ secretkeyì™€ token claims í™•ì¸)
    - true => refreshToken ìœ¼ë¡œ userIDë¥¼ ì°¾ê³  userIDë¥¼ í†µí•´ user ì •ë³´ë¥¼ ì°¾ì•„ë‚´ì–´ TokenProvider ì—ì„œ generateToken ë©”ì†Œë“œ ì‹¤í–‰(ì•¡ì„¸ìŠ¤ í† í° ìƒì„± ë° ë°œê¸‰)
    - false => ì—ëŸ¬ì²˜ë¦¬


## OAuth2 ê¸°ë°˜ ì¸ì¦







# ì •ë³´ì²˜ë¦¬ê¸°ì‚¬ í•„ê¸° ê³µë¶€
SEC. ~ SEC. + ì´ì „ ê³µë¶€í–ˆë˜ ë‚´ìš© ë³µìŠµ