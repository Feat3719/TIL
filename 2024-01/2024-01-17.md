# 2024-01-17
----------------

# Nomore í”„ë¡œì íŠ¸ - 1ì¼ì°¨

## Infra
> ì£¼ì œ : ì „ìì œí’ˆ ì‡¼í•‘ëª°

1. ê¸°ìˆ ìŠ¤íƒ ì„ ì •   
FE : react   
BE : springboot/tomcat   
Cloud : aws/ec2/ubuntu + Docker + Nginx   
SCMT : nothion, git, github   
CI/CD : github actions   
<br><br>




2. ì¸í”„ë¼ êµ¬ì¶•   

(1) AWS EC2 (Ubuntu)ì¸ìŠ¤í„´ìŠ¤ ìƒì„±   

(2) ì„œë²„ êµ¬ë™   
- AWS ì—ì„œ bash ì—´ê¸° í˜¹ì€ .sh íŒŒì¼ ì¡´ì¬í•˜ëŠ” ë””ë ‰í„°ë¦¬ì—ì„œ bash ì‹¤í–‰ í›„ .sh íŒŒì¼(deploy/nomore_ssh.sh) ì¸ì¦ì„œ ë“œë˜ê·¸
í˜¹ì€ 
- AWS EC2 ì¸ìŠ¤í„´ìŠ¤ ì—°ê²°->SSH í´ë¼ì´ì–¸íŠ¸ì—ì„œ ssh -i ë¶€ë¶„ ë³µì‚¬ í›„ ì‹¤í–‰

(3) docker ì„¤ì¹˜   

- ê´€ë¦¬ì ê¶Œí•œ ì£¼ê¸°   
```bash
sudo su
```   

- íŒ¨í‚¤ì§€ ëª©ë¡ ì—…ë°ì´íŠ¸
```bash
apt-get update
```

- ëª¨ë“  íŒ¨í‚¤ì§€ ìµœì‹  ë²„ì ¼ìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œ
```bash
apt-get upgrade
```

- í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
```bash
apt-get install apt-transport-https ca-certificates curl gnupg-agent software-properties-common
```

- Dockerì˜ ê³µì‹ GPGí‚¤ë¥¼ ì¶”ê°€
```bash
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
```

- Dockerì˜ ê³µì‹ apt ì €ì¥ì†Œë¥¼ ì¶”ê°€
```bash
add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
```

- íŒ¨í‚¤ì§€ ëª©ë¡ ì—…ë°ì´íŠ¸
```bash
apt-get update
```

-  Docker ì„¤ì¹˜
```bash
apt-get install docker-ce docker-ce-cli containerd.io
```

- Docker-Compose ì„¤ì¹˜
```bash
curl \
-L "https://github.com/docker/compose/releases/download/1.26.2/docker-compose-$(uname -s)-$(uname -m)" \
-o /usr/local/bin/docker-compose
```

- Docker-Compose ì‹¤í–‰ ê¶Œí•œ ì£¼ê¸°
```bash
chmod +x /usr/local/bin/docker-compose
```
(4) dockerhub ê°€ì… ë° ì—‘ì„¸ìŠ¤ í† í° ë‹¤ìš´ë°›ê³ (Access Token Description : Feat) c:/deploy/ ì— docker_token.txt íŒŒì¼ë¡œ ì €ì¥   

(5) ë„ì»¤ ì»´í“¨í„°ì— ë‹¤ìš´ë¡œë“œ

(6) ë„ì»¤ ë¡œê·¸ì¸(ì•„ì´ë”” : ë„ì»¤ í™ˆí˜ì´ì§€ ì•„ì´ë”” / ë¹„ë°€ë²ˆí˜¸ : docker_token.txt ë‚´ë¶€ ì“°ì—¬ìˆëŠ” íŒ¨ìŠ¤ì›Œë“œ)
```bash
docker login
```
(6) Nginx ì„¤ì¹˜   
- Nginx ì„¤ì¹˜   
```bash
docker pull nginx
``` 
- docker container run   
```bash
## -d : ì»¨í…Œì´ë„ˆë¥¼ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰(í„°ë¯¸ë„ì„ ì°¨ì§€í•˜ì§€ì•Šê³  ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‘ë™)
## -p : (or --publish) í˜¸ìŠ¤íŠ¸ì™€ ì»¨í…Œì´ë„ˆ ê°„ì˜ í¬íŠ¸ ë§¤í•‘ì„ ì§€ì •(í˜¸ìŠ¤íŠ¸í¬íŠ¸:ì»¨í…Œì´ë„ˆí¬íŠ¸)
docker container run --name nginxserver -d -p 80:80 nginx 
```

    
(7) Nginx ì„¤ì •
- Nginx ì»¨í…Œì´ë„ˆì— ë“¤ì–´ê°€ê¸°
```bash
docker exec -it nginxserver bash
```
- /etc/nginx/conf.d#/ ë¡œ ì´ë™
```bash
cd /etc/nginx/conf.d#
```
- íŒ¨í‚¤ì§€ ëª©ë¡ ì—…ë°ì´íŠ¸
```bash
apt-get upgrade
```
- vim ì—ë””í„° ì„¤ì¹˜
```bash
apt-get install vim
```
- vim ì—ë””í„° ì—´ê¸°
```bash
vim default.conf
```
- a ë¥¼ ëˆ„ë¥´ê³  í¸ì§‘ëª¨ë“œon í›„ ë°‘ ì½”ë“œ ì ìš©   
    - vim ì—ë””í„° ê°„ë‹¨ ë‹¨ì¶•í‚¤
        - ë‚˜ê°€ê¸° <b>:q</b>
        - ì €ì¥í•˜ê¸° <b>:w</b>
        - ì €ì¥í•˜ê³  ë‚˜ê°€ê¸° <b>:wq</b>
        - ë’¤ë¡œê°€ê¸° <b>u</b>
        - í¸ì§‘ëª¨ë“œon <b>a</b>
        - í¸ì§‘ëª¨ë“œoff <b>esc</b>

```bash
upstream blue {
        server 172.31.4.201:7070;
}
upstream green {
        server 172.31.4.201:7071;
}
server {
    listen  80;
    listen [::]80;
    server_name localhost;

    #access_log /var ~~

    include /etc/nginx/conf.d/service-env.inc;

    location / {
        proxy_pass http://$service_url;

        proxy_set_header X-Real_IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $http_host;

        root /usr/share/nginx/html;
        index index.html index.htm;
    }

}
```
- service-env.inc íŒŒì¼ ìƒì„± í›„ ë°‘ ì½”ë“œì™€ ê°™ì´ í¸ì§‘($service_url ì„ green ìœ¼ë¡œ set)   
    - â­ Blue-Green ë¬´ì¤‘ë‹¨ ë°°í¬ êµ¬í˜„
```bash
set $service_url green;
```


## ğŸƒ Springboot
- HealthCheckController.java ìƒì„±
```java
package com.sprint.nomore.controller;

import java.util.Map;
import java.util.TreeMap;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;


@RestController
public class HealthCheckcontroller {
    
    @Value("${server.env}")
    private String env;
    @Value("${server.port}")
    private String serverPort;
    @Value("${server.serverAddress}")
    private String serverAddress;
    @Value("${serverName}")
    private String serverName;

    @GetMapping("/rc")
    public ResponseEntity<?> healthCheck() {
        Map<String, String> response = new TreeMap<>();
        response.put("serverName", serverName);
        response.put("serverPort", serverPort);
        response.put("serverAddress", serverAddress);
        response.put("env", env);
        return ResponseEntity.ok(response);
    }

    @GetMapping("/env")
    public ResponseEntity<?> getEnv() {
        return ResponseEntity.ok(env);
    }
}

```

- application.properties ìˆ˜ì •
```properties
spring.profiles.active=local
spring.profiles.group.local=local, common, secret
spring.profiles.group.blue=blue, common, secret
spring.profiles.group.green=green, common, secret
server.env=blue
spring.config.activate.on-profile=common
```   

- application-local.properties ìƒì„±
```properties
spring.config.activate.on-profile=local
server.port=8080
server.address==localhost
server.servlet.application-display-name=local_server
```

- application-blue.properties ìƒì„±
```properties
spring.config.activate.on-profile=blue
server.port=8080
server.address==43.200.226.40
server.servlet.application-display-name=blue_server
```

- application-green.properties ìƒì„±
```properties
spring.config.activate.on-profile=green
server.port=8081
server.address==43.200.226.40
server.servlet.application-display-name=green_server
```
