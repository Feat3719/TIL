# 2024-01-18

---

# Nomore í”„ë¡œì íŠ¸ - 2ì¼ì°¨

## Infra

> ì£¼ì œ : ì „ìì œí’ˆ ì‡¼í•‘ëª°

1. ê¸°ìˆ ìŠ¤íƒ ì„ ì •  
   FE : react  
   BE : springboot/tomcat  
   Cloud : aws/ec2/ubuntu + Docker + Nginx  
   SCMT : nothion, git, github  
   CI/CD : github actions  
   <br><br>

2. ì¸í”„ë¼ êµ¬ì¶•

(8) docker-compose-blue.yml, docker-compose-green.yml ì‘ì„±

- docker ë‚˜ì˜¨ í›„

```bash
exit
```

- docker-compose-blue yml ì‘ì„±

```bash
vim docker-compose-blue.yml
```

```bash
version: '3.8'
services:
    blue:
        image:featdev/nomore_server:latest
        container_name: blue
        ports:
            - "8080:8080"
        environment:
            - PROFILES=blue
            - ENV=blue
```

- docker-compose-green yml ì‘ì„±

```bash
version: '3.8'
services:
    blue:
        image:featdev/nomore_server:latest
        container_name: green
        ports:
            - "8081:8081"
        environment:
            - PROFILES=green
            - ENV=green
```

(9) Github Actions yml ì½”ë“œ ì‘ì„±
=> .github/workflows/CICD.yml

```yml
name: CICD

## main ë¸Œëœì¹˜ì— push, pull request ê°€ ì¼ì–´ë‚  ë•Œ ë™ì‘ì„ í•œë‹¤ ##
on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

## ì½ê¸° ê¶Œí•œ ë¶€ì—¬ ##
permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Install JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Build with Maven
        run: |
          chmod 777 ./mvnw
          ./mvnw clean package -Dtestskip

      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build Docker
        run: docker build --platform linux/amd64 -t ${{ secrets.DOCKERHUB_USERNAME }}/live_server .
      - name: Push Docker
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/live_server:latest

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Set target IP
        run: |
          STATUS=$(curl -o /dev/null -w "%{http_code}" "http://${{ secrets.LIVE_SERVER_IP }}/env")
          echo $STATUS
          if [ $STATUS = 200 ]; then
            CURRENT_UPSTREAM=$(curl -s "http://${{ secrets.LIVE_SERVER_IP }}/env")
          else
            CURRENT_UPSTREAM=green
          fi
          echo CURRENT_UPSTREAM=$CURRENT_UPSTREAM >> $GITHUB_ENV
          if [ $CURRENT_UPSTREAM = blue ]; then
            echo "CURRENT_PORT=8080" >> $GITHUB_ENV
            echo "STOPPED_PORT=8081" >> $GITHUB_ENV
            echo "TARGET_UPSTREAM=green" >> $GITHUB_ENV
          elif [ $CURRENT_UPSTREAM = green ]; then
            echo "CURRENT_PORT=8081" >> $GITHUB_ENV
            echo "STOPPED_PORT=8080" >> $GITHUB_ENV
            echo "TARGET_UPSTREAM=blue" >> $GITHUB_ENV
          else
            echo "error"
            exit 1
          fi

      - name: Docker compose
        uses: appleboy/ssh-action@master
        with:
          username: ubuntu
          host: ${{ secrets.LIVE_SERVER_IP }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script_stop: true
          script: |
            sudo docker pull ${{ secrets.DOCKERHUB_USERNAME }}/live_server:latest
            sudo docker-compose -f docker-compose-${{env.TARGET_UPSTREAM}}.yml up -d

      - name: Check deploy server URL
        uses: jtalk/url-health-check-action@v3
        with:
          url: http://${{ secrets.LIVE_SERVER_IP }}:${{env.STOPPED_PORT}}/env
          max-attempts: 3
          retry-delay: 10s

      - name: Change nginx upstream
        uses: appleboy/ssh-action@master
        with:
          username: ubuntu
          host: ${{ secrets.LIVE_SERVER_IP }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script_stop: true
          script: |
            sudo docker exec -i nginxserver bash -c 'echo "set \$service_url ${{ env.TARGET_UPSTREAM }};" > /etc/nginx/conf.d/service-env.inc && nginx -s reload'

      - name: Stop current server
        uses: appleboy/ssh-action@master
        with:
          username: ubuntu
          host: ${{ secrets.LIVE_SERVER_IP }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script_stop: true
          script: |
            sudo docker stop ${{env.CURRENT_UPSTREAM}}
            sudo docker rm ${{env.CURRENT_UPSTREAM}}
```

(10) Dockerfile ì‘ì„±

> Springboot í”„ë¡œì íŠ¸ ìµœìƒë‹¨ì— ìƒì„±(Dockerfile)

```docker
FROM amazoncorretto:11
ARG JAR_FILE=build/libs/*.jar
ARG PROFILES
ARG ENV
COPY ${JAR_FILE} app.jar
ENTRYPOINT ["java","-Dspring.profiles.active=${PROFILES}","-Dserver.env=${ENV}","-jar","/app.jar"]
```

(11) Github actions ì‹œí¬ë¦¿ í‚¤ ìƒì„±

- í•´ë‹¹ í”„ë¡œì íŠ¸ settings -> Secrets and variables -> Actions - DOCKERHUB_USERNAME - DOCKERHUB_TOKEN - EC2_SSH_KEY - LIVE_SERVER_IP
  (12) main ë¸Œëœì¹˜ push ë¥¼ í†µí•´ CI/CD ìˆ˜í–‰
  => Check deploy server URL ë¶€ë¶„ì—ì„œ ë²„ê·¸ ë°œìƒ

### DNS ì„¤ì • (Route53)

- Route53ì— ë ˆì½”ë“œ ìƒì„± í›„ í˜¸ìŠ¤íŒ…Krê³¼ ê°’/íŠ¸ë˜í”½ ë¼ìš°íŒ… ëŒ€ìƒ ë§¤í•‘
- A ë ˆì½”ë“œ í•˜ë‚˜ ë” ìƒì„± í›„ EC2 ì™€ ì—°ê²°ëœ Elastic-IP ë“±ë¡

## ğŸƒ Springboot

## â™¾ï¸ React

(1) Dockerfile ì‘ì„±

```dockerfile
FROM node:alpine as builder ## node:alpine ì´ë¯¸ì§€ë¥¼ ê¸°ë°˜ìœ¼ë¡œ "builder"ë¼ëŠ” ì´ë¦„ì˜ ìƒˆ ë¹Œë“œ ìŠ¤í…Œì´ì§€ë¥¼ ìƒì„±. node:alpineì€ Node.jsê°€ ì„¤ì¹˜ëœ ê°€ë²¼ìš´ ì•ŒíŒŒì¸ ë¦¬ëˆ…ìŠ¤ë¥¼ ì‚¬ìš©
WORKDIR /usr/src/app ## ì‘ì—… ë””ë ‰í† ë¦¬ë¥¼ ì„¤ì •í•˜ëŠ” ë¶€ë¶„. ì´ ë””ë ‰í† ë¦¬ëŠ” ì´í›„ì˜ ëª…ë ¹ë“¤ì´ ì‹¤í–‰ë˜ëŠ” ë””ë ‰í† ë¦¬ë¥¼ ì§€ì •
COPY package.json . ## í˜„ì¬ ë””ë ‰í† ë¦¬ì˜ package.json íŒŒì¼ì„ ì´ë¯¸ì§€ ë‚´ /usr/src/app ë””ë ‰í† ë¦¬ì— ë³µì‚¬í•˜ëŠ” ëª…ë ¹
RUN npm install ## npm ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤ ì„¤ì¹˜
COPY ./ ./ ## í˜„ì¬ ë””ë ‰í† ë¦¬ì˜ ëª¨ë“  íŒŒì¼ê³¼ í´ë”ë¥¼ ì´ë¯¸ì§€ì˜ /usr/src/app ë””ë ‰í† ë¦¬ì— ë³µì‚¬
RUN npm run build ## í”„ë¡œì íŠ¸ ë¹Œë“œ.

FROM nginx
EXPOSE 3000
COPY ./default.conf /etc/nginx/conf.d/default.conf
COPY --from=builder usr/src/app/build /usr/share/nginx/html
```
