# 2024-02-26

---

### Ïò§Îäò Ìï¥Ïïº Ìï† Í≤É

##### 1. Í∏∞ÏóÖ ÌîÑÎ°úÏ†ùÌä∏ Ïõπ ÏãúÏó∞ Ïó∞Ïäµ [‚úÖ]

##### 2. ÏûêÏÜåÏÑú ÏûëÏÑ± Î∞è Íµ¨ÏßÅ ÏÇ¨Ïù¥Ìä∏ ÏÑ∏ÌåÖ []

1. ÏûêÏÜåÏÑú ÏûëÏÑ± []
2. Íµ¨ÏßÅ ÏÇ¨Ïù¥Ìä∏ ÏÑ∏ÌåÖ[]

- ÏÇ¨ÎûåÏù∏ []
- Ïû°ÏΩîÎ¶¨ÏïÑ []
- Ï∫êÏπò []
- Ïû°ÌîåÎûòÎãõ []
- ÏõêÌã∞Îìú []
- Ï†êÌïè [üõÜ]
- ÌîÑÎ°úÍ∑∏ÎûòÎ®∏Ïä§ []
- ÎßÅÌÅ¨ÎìúÏù∏ []

##### 3. SQLD ÏûêÍ≤©Ï¶ù Í≥µÎ∂Ä []

- SQLD Í∏∞Ï∂ú 3Ìöå

### Î∞∞Ïö¥Ï†ê

#### 1. git Î∏åÎûúÏπò ÏÇ≠Ï†ú

- git Î°úÏª¨ Î∏åÎûúÏπò ÏÇ≠Ï†ú

```bash
git branch -D Î∏åÎûúÏπòÎ™Ö
```

- git ÏõêÍ≤© Ï†ÄÏû•ÏÜå ÏÇ≠Ï†ú

```bash
git push origin --delete Î∏åÎûúÏπòÎ™Ö
```

#### 2. application.properties Î∞è keystore.p12 Îì± ÌôòÍ≤Ω Î≥ÄÏàò Github action ÏóêÏÑúÏùò Ï≤òÎ¶¨

- application.properties ÏôÄ keystore.p12 ÌååÏùºÏùÑ C:/User/user ÎÇ¥Î∂ÄÏóê Î≥µÏÇ¨Ìï¥ÎëêÍ≥† cmd Ïóê Î∞ë Î™ÖÎ†πÏñ¥ ÏûÖÎ†•.

```shell
[Convert]::ToBase64String([IO.File]::ReadAllBytes("application.properties")) | Set-Clipboard
```

```shell
[Convert]::ToBase64String([IO.File]::ReadAllBytes("keystore.p12")) | Set-Clipboard
```

- base64 ÌòïÏãùÏúºÎ°ú Ïù∏ÏΩîÎî© Îêú ÏΩîÎìúÍ∞Ä ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨Îêå. => github action secret Ïóê `APPLICATION_PROPERTIES ` ÎùºÎäî Ïù¥Î¶ÑÏúºÎ°ú Ï†ÄÏû•
- keystore.p12 ÎèÑ ÎßàÏ∞¨Í∞ÄÏßÄÎ°ú `KEYSTORE_FILE` ÎùºÎäî Ïù¥Î¶ÑÏúºÎ°ú secret Ïóê Ï†ÄÏû•
- Í∑∏ ÌõÑ cicd.yml ÌååÏùºÏóê ÏïÑÎûò Îã®Í≥Ñ Î∂ôÏó¨ÎÑ£Í∏∞

```yml
- name: Restore keystore file from Secret
  run: |
    echo "${{ secrets.KEYSTORE_FILE }}" | base64 -d > src/main/resources/keystore.p12

- name: Restore application.properties from Secret
  run: |
    echo "${{ secrets.APPLICATION_PROPERTIES }}" | base64 -d > src/main/resources/application.properties
```

#### 3. docker-compose ÌååÏùº ÌôòÍ≤Ω Î≥ÄÏàò Github action Ï≤òÎ¶¨

- docker-compose.yml Ïóê Îì§Ïñ¥Í∞à ÌôòÍ≤ΩÎ≥ÄÏàòÎ•º .env ÌååÏùºÏùÑ ÏÉùÏÑ±ÌïòÏó¨ .env ÌååÏùºÏóê ÌôòÍ≤ΩÎ≥ÄÏàòÎ•º ÏßÄÏ†ïÌï¥Ï£ºÍ≥† Ïù¥Î•º docker-compose.yml ÌååÏùºÏóêÏÑú Î∂àÎü¨ÏôÄ ÏßÑÌñâ

```yml
## docker-compose.yml ##
version: "3"
services:
  app:
    build: .
    ports:
      - "443:443"
    environment:
      SERVER_SSL_KEY_STORE: "${SERVER_SSL_KEY_STORE}"
      SERVER_SSL_KEY_STORE_PASSWORD: "${SERVER_SSL_KEY_STORE_PASSWORD}"
      SERVER_SSL_KEY_STORE_TYPE: "${SERVER_SSL_KEY_STORE_TYPE}"
      SERVER_SSL_KEY_ALIAS: "${SERVER_SSL_KEY_ALIAS}"
```

```yml
## Ï∂îÍ∞ÄÌï† cicd.yml ##
## env ÌååÏùº ÏÉùÏÑ± ##
- name: Create .env file
  run: |
    echo SERVER_SSL_KEY_STORE=${{ secrets.SERVER_SSL_KEY_STORE }} > .env
    echo SERVER_SSL_KEY_STORE_PASSWORD=${{ secrets.SERVER_SSL_KEY_STORE_PASSWORD }} >> .env
    echo SERVER_SSL_KEY_STORE_TYPE=${{ secrets.SERVER_SSL_KEY_STORE_TYPE }} >> .env
    echo SERVER_SSL_KEY_ALIAS=${{ secrets.SERVER_SSL_KEY_ALIAS }} >> .env

## docker-compose Ïã§Ìñâ ##
- name: Run Docker Compose
  env:
    SERVER_SSL_KEY_STORE: ${{ secrets.SERVER_SSL_KEY_STORE }}
    SERVER_SSL_KEY_STORE_PASSWORD: ${{ secrets.SERVER_SSL_KEY_STORE_PASSWORD }}
    SERVER_SSL_KEY_STORE_TYPE: ${{ secrets.SERVER_SSL_KEY_STORE_TYPE }}
    SERVER_SSL_KEY_ALIAS: ${{ secrets.SERVER_SSL_KEY_ALIAS }}
  run: |
    docker-compose up -d
```

```yml
## Ï†ÑÏ≤¥ cicd.yml ##
name: Spring Boot CI/CD Pipeline with Gradle

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Install JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Restore keystore file from Secret
        run: |
          echo "${{ secrets.KEYSTORE_FILE }}" | base64 -d > src/main/resources/keystore.p12

      - name: Restore application.properties from Secret
        run: |
          echo "${{ secrets.APPLICATION_PROPERTIES }}" | base64 -d > src/main/resources/application.properties

      - name: Build with Gradle
        run: ./gradlew clean build -x test

      - name: Login to DockerHub
        env:
          REGISTRY_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
          REGISTRY_PASSWORD: ${{ secrets.DOCKER_HUB_PASSWORD }}
        run: |
          echo "$REGISTRY_PASSWORD" | docker login -u "$REGISTRY_USERNAME" --password-stdin
      - name: Build Docker
        env:
          REGISTRY_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
        run: docker build -t ${{ secrets.DOCKER_HUB_USERNAME }}/seahield .
      - name: Push Docker
        env:
          REGISTRY_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
        run: docker push ${{ secrets.DOCKER_HUB_USERNAME }}/seahield:latest

      - name: Create .env file for Docker Compose
        run: |
          echo SERVER_SSL_KEY_STORE=${{ secrets.SERVER_SSL_KEY_STORE }} > .env
          echo SERVER_SSL_KEY_STORE_PASSWORD=${{ secrets.SERVER_SSL_KEY_STORE_PASSWORD }} >> .env
          echo SERVER_SSL_KEY_STORE_TYPE=${{ secrets.SERVER_SSL_KEY_STORE_TYPE }} >> .env
          echo SERVER_SSL_KEY_ALIAS=${{ secrets.SERVER_SSL_KEY_ALIAS }} >> .env

      - name: Run Docker Compose
        run: docker-compose up -d
        env:
          SERVER_SSL_KEY_STORE: ${{ secrets.SERVER_SSL_KEY_STORE }}
          SERVER_SSL_KEY_STORE_PASSWORD: ${{ secrets.SERVER_SSL_KEY_STORE_PASSWORD }}
          SERVER_SSL_KEY_STORE_TYPE: ${{ secrets.SERVER_SSL_KEY_STORE_TYPE }}
          SERVER_SSL_KEY_ALIAS: ${{ secrets.SERVER_SSL_KEY_ALIAS }}

      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        env:
          REGISTRY_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
        with:
          host: ${{ secrets.EC2_HOST_IP }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY_NEW }}
          script: |
            sudo docker pull ${{ secrets.DOCKER_HUB_USERNAME }}/seahield
            sudo docker stop myapp || true
            sudo docker rm myapp || true
            sudo docker run -d --name myapp -p 443:443 ${{ secrets.DOCKER_HUB_USERNAME }}/seahield
```

### ÎÇ¥Ïùº Ìï¥Ïïº Ìï† Í≤É
